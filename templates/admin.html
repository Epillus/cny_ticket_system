<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>春晚票务管理系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }
        
        .container {
            margin-top: 20px;
        }
        
        h1 {
            margin-bottom: 30px;
            color: #333;
        }
        
        .stats-card {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .stats-number {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stats-label {
            font-size: 18px;
            color: #666;
        }
        
        .ticket-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .ticket-item.unchecked {
            background-color: #ffffff;
            border-left: 5px solid #dc3545;
        }
        
        .ticket-item.checked {
            background-color: #d4edda;
            border-left: 5px solid #28a745;
        }
        
        .ticket-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ticket-name {
            font-size: 20px;
            font-weight: bold;
        }
        
        .ticket-id {
            color: #666;
        }
        
        .ticket-status {
            font-weight: bold;
        }
        
        .status-checked {
            color: #28a745;
        }
        
        .status-unchecked {
            color: #dc3545;
        }
        
        .recent-activity {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            margin-bottom: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .activity-time {
            color: #999;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">春晚票务管理系统</h1>
        
        <!-- 统计信息 -->
        <div class="row">
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-number" id="total-tickets">0</div>
                        <div class="stats-label">总票数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-number" id="checked-tickets">0</div>
                        <div class="stats-label">已检票数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-number" id="unchecked-tickets">0</div>
                        <div class="stats-label">未检票数</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 导出功能 -->
        <div class="mb-4 text-center">
            <button id="export-btn" class="btn btn-primary btn-lg">导出当天来的所有人</button>
        </div>
        
        <div class="row">
            <!-- 左侧：所有票列表 -->
            <div class="col-md-8">
                <h2>票务列表</h2>
                <div id="tickets-list"></div>
            </div>
            
            <!-- 右侧：最近活动 -->
            <div class="col-md-4">
                <h2>最近检票记录</h2>
                <div class="recent-activity">
                    <div id="activity-list">
                        <p class="text-center text-muted">暂无检票记录</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/socket.io@4.5.1/client-dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 连接Socket.IO
        const socket = io();
        
        // 初始化数据
        const tickets = {{ tickets|tojson }};
        let ticketMap = {};
        
        // 统计信息
        let totalTickets = tickets.length;
        let checkedTickets = 0;
        let uncheckedTickets = 0;
        
        // 活动记录
        const activities = [];
        
        // 初始化页面
        function initPage() {
            // 创建票号映射
            tickets.forEach(ticket => {
                ticketMap[ticket.ticket_id] = ticket;
                if (ticket.status === 'checked') {
                    checkedTickets++;
                }
            });
            uncheckedTickets = totalTickets - checkedTickets;
            
            // 更新统计信息
            updateStats();
            
            // 渲染票列表
            renderTicketsList();
        }
        
        // 更新统计信息
        function updateStats() {
            document.getElementById('total-tickets').textContent = totalTickets;
            document.getElementById('checked-tickets').textContent = checkedTickets;
            document.getElementById('unchecked-tickets').textContent = uncheckedTickets;
        }
        
        // 渲染票列表
        function renderTicketsList() {
            const ticketsList = document.getElementById('tickets-list');
            ticketsList.innerHTML = '';
            
            // 按票号排序
            const sortedTickets = Object.values(ticketMap).sort((a, b) => {
                return a.ticket_id.localeCompare(b.ticket_id);
            });
            
            sortedTickets.forEach(ticket => {
                const ticketElement = document.createElement('div');
                ticketElement.className = `ticket-item ${ticket.status}`;
                ticketElement.dataset.ticketId = ticket.ticket_id;
                
                const statusClass = ticket.status === 'checked' ? 'status-checked' : 'status-unchecked';
                const statusText = ticket.status === 'checked' ? '已检票' : '未检票';
                
                ticketElement.innerHTML = `
                    <div class="ticket-info">
                        <div>
                            <div class="ticket-name">${ticket.name}</div>
                            <div class="ticket-id">票号: ${ticket.ticket_id}</div>
                        </div>
                        <div>
                            <div class="ticket-status ${statusClass}">${statusText}</div>
                            ${ticket.checkin_time ? `<div class="ticket-time">${ticket.checkin_time}</div>` : ''}
                        </div>
                    </div>
                `;
                
                ticketsList.appendChild(ticketElement);
            });
        }
        
        // 添加活动记录
        function addActivity(name, ticketId, time) {
            const activity = {
                name: name,
                ticketId: ticketId,
                time: time
            };
            
            activities.unshift(activity);
            
            // 只保留最近20条记录
            if (activities.length > 20) {
                activities.pop();
            }
            
            renderActivities();
        }
        
        // 渲染活动记录
        function renderActivities() {
            const activityList = document.getElementById('activity-list');
            
            if (activities.length === 0) {
                activityList.innerHTML = '<p class="text-center text-muted">暂无检票记录</p>';
                return;
            }
            
            activityList.innerHTML = '';
            
            activities.forEach(activity => {
                const activityElement = document.createElement('div');
                activityElement.className = 'activity-item';
                activityElement.innerHTML = `
                    <div><strong>${activity.name}</strong> (${activity.ticketId})</div>
                    <div class="activity-time">${activity.time}</div>
                `;
                activityList.appendChild(activityElement);
            });
        }
        
        // 处理票被扫描事件
        socket.on('ticket_checked', (data) => {
            const { ticket_id, name, checkin_time } = data;
            
            // 更新票状态
            if (ticketMap[ticket_id]) {
                ticketMap[ticket_id].status = 'checked';
                ticketMap[ticket_id].checkin_time = checkin_time;
            }
            
            // 更新统计信息
            checkedTickets++;
            uncheckedTickets--;
            updateStats();
            
            // 重新渲染票列表
            renderTicketsList();
            
            // 添加活动记录
            addActivity(name, ticket_id, checkin_time);
        });
        
        // 导出功能
        document.getElementById('export-btn').addEventListener('click', () => {
            window.location.href = '/export_today';
        });
        
        // 初始化
        window.addEventListener('load', initPage);
    </script>
</body>
</html>
